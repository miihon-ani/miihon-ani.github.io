# スキルのAUTO発動優先順位について
Markdownで書いてみる練習を兼ねてテスト

## 自分では不可能な検証依頼
- 分類不能系
    - 正月キャラ持ちの人：正月エンチャントの優先順位
    - フィート+正月キャラ持ちの人：フィートs2と正月エンチャントの優先順位
    - 色指定のリキャスト回復は未チェック
- リジェネ系複合スキル
    - 水着エーテル
    - アウスレーゼ、シモーネが未検証

## 発動優先順位
1. スキル特性に依る優先順位
    1. 回復
    1. 味方バフ
    1. 敵デバフ
    1. ダメージ
    1. その他（分類不能）
        - スタンやスキル硬直等でスキルが使用不可能な状態のキャラクターは無視される
1. キャラ位置による優先順位
    - キャラ位置左（リーダー）から順番

## 発動における留意点
- 前提として、スキル特性が同一であればキャラ位置に引き渡される
- 複合スキルについては、その時発動する優先順位が最も高い効果として発動する
    - 「回復」で特記するが、回復が発動しない状態ではその次点効果となる
    - 同一の「味方バフ」も重複しないため、既にかかっている場合は次点効果をとる
- 手動と異なり、連続使用時でも僅かにタイムラグがある
    - そのため最初に発動したキャラのスキル硬直が（同一waveで）解けるタイミングでは、他のキャラのスキル硬直が解けていない
    - タイムラグ中に優先順位が上回る別スキルの条件を満たした場合（以下の例が顕著）でも、チェック時点で選ばれていたスキルを発動する
        - ラグ中の攻撃により、選択されたものよりも高優先度スキルのリキャストが回復した場合
        - ラグ中の攻撃により、かかっていたバフが切れたことで、味方バフの優先順位が上がった場合
        - ラグ中にダメージや状態異常を被弾し、回復系スキルの優先順位が上がった場合

## スキル特性に依る優先順位詳細

### 回復
「回復」に分類されるスキル
- HP回復スキル
- 状態異常回復スキル
    - スタン回復スキル

#### 回復の特記事項
- HP回復スキルはある程度のダメージの被弾後、状態異常回復スキルはその効果が必要になったタイミングで最優先となる
    - 言い換えると「wave開幕時にHPが満タンから始まる場合、スキル発動の対象にならない」
        - 無論、敵のスキルによる先制攻撃を受けた場合は状況次第でチェック対象になる
    - HP回復スキルの発動タイミングは、およそ「そのHP回復スキルで回復できる量」と推測される
        - そのためHP回復特大は発動閾値となるタイミングが既に即死圏で、発動前に抱え落ちとなるケースが発生しうる
            - エーテルs1が顕著（被ダメージ2万程度が必要になるためPTメンバー次第でそもそも発動不可となりうる）
        - 恐らくその対策で２回回復スキルが実装されているが、こちらは閾値が下がる代わりに回復余りが発生しやすい
            - 閾値計算は回復１回分でされるため、オート抱え落ちと回復余り発生のトレードオフである
        - 閾値は検証待ちだが、恐らく最低乱数時の回復値であると思われる 
            - バフ/デバフによる回復量変化は加味されないことに注意
                - やや余談だがオート事故で多い死因は「魔デバフ付きダメージを受けた後に回復を連打してジリ貧～負け」である
                - ただしリーダースキルはパッシブのため効いていると推測される（これから裏付けを取る）
- ダメージと回復の複合時で、回復による発動時は、常に一番左側の敵を対象に取る
    - 味方バフは修正されたのにこっちは2018年末現在残っている様子

### 味方バフ
「味方バフ」に分類されるスキル
- ステータスバフスキル
    - 攻撃バフ
    - 魔法バフ
    - 速度バフ
- 属性耐性スキル
    - 火耐性
    - 水耐性
    - 風耐性
    - 土耐性
- 状態異常耐性スキル
    - 沈黙耐性
    - 毒耐性
    - 攻撃減少耐性
    - 魔法減少耐性
    - 速度減少耐性
- 攻撃時追加行動スキル（※）
    - リジェネ
    - エンチャント（？）
- 攻撃回数アップ
    - 特定属性攻撃回数アップ
- 弱点属性特攻
- 復活
- 反射
- etc.（物理／魔法の反射系は現状味方未実装だがおそらくここ）

※厳密には「行動時追加」と「攻撃時追加」で優先度が異なると思われ、また一部は（未分類）と同様の優先度最低と分類されうるデータがあるため、追加調査中。特記に記載

#### 味方バフの特記
- 既にかかっているバフは発動対象とならない
    - 効果が２つ以上複合するバフは、「そのすべてが既にかかっている場合」は発動しない
        - 逆に言うと「一つでもバフ効果が発動する複合バフは発動する」
        - 例：攻撃バフのみが掛かった状態で攻撃/魔法の複合バフは発動する
    - 攻撃回数は「攻撃回数」がバフの大きさに相当するため重複しない
        - 攻撃回数が2回になるバフと3回になるバフは重複せず、複合などでの重複時は最初にかけた回数となる
    - 例外として、攻撃時追加行動スキルは同一であっても重複する
        - ミントs1、カーリスs1の重ね掛けを確認
- 回復+リジェネの場合、回復が発動しない場合にリジェネ単体で使用されることはない 
    - エーテルs1で確認
    - アウスレーゼ、シモーネは未確認
- リジェネ単体の場合、「他のバフ＞リジェネ＞敵デバフ」という微妙な優先度であることが確認されている
    - 言い換えると、キャラ位置が前のリジェネよりも後続味方バフが優先される
    - 現状例が少ないため端折るが、味方デバフと敵デバフの間にもう１分類必要になる可能性がある
    - サンカs3で確認
- 一部キャラクターのエンチャントは、敵デバフよりも優先順位が低いことが確認されている
    - 初詣メダカのs3で確認
    - 恐らく最低順位で、正月組は同様と思われるが未確認
- ダメージとバフの複合時で、バフによる発動時であった場合、適切に対象を取るように修正された（2018年夏ごろ）
    - 修正前はバフタイミング時であれば常に一番左側の敵を対象に取っていた（当時各花魔王s3で確認、記録として残す）
- 攻撃スキルに付属しているエンチャントは、攻撃スキルのタイミングでの発動が確認されている
    - 上記正月組のエンチャントと同レベルのために、それより優先度の高い攻撃スキルとして放たれているものと推測
    - ミントs1、カーリスs1の発動順位から推測

### 敵デバフ
「敵デバフ」に分類されるスキル
- ステータスデバフスキル
    - 攻撃デバフ
    - 魔法デバフ
    - 速度デバフ
- 状態異常スキル
    - 毒
    - 猛毒
    - 沈黙
    - スタン

#### 敵デバフの特記
- バフとは異なり、既にかかっているデバフであっても発動対象となる
    - 効果の大きさが全く同じスキルであっても使用される（ミントを二人入れた状態のS3LvMaxで確認）
- 単体対象の場合、対象優先度が通常時と異なる
    - ダメージとの複合時は未検証、恐らくバフと同様適切なダメージ対象を取っているはず
    - 通常攻撃及びダメージスキルにおける優先度が最も低い敵を狙うと推定される
        - つまり基本的（≒こぶん複合時以外）には「属性相性悪い順」→「残HP多い順」→「位置右側」の順番で判定されている（と思われる）

### ダメージ
「ダメージ」に分類されるスキル
- 物理ダメージスキル
- 魔法ダメージスキル
- 固定ダメージスキル
- 割合ダメージスキル

#### ダメージの特記
- 単体対象スキルの場合、通常のオート攻撃と同じ優先度であると思われる
    - 基本的（≒こぶん複合時以外）には「属性相性良い順」→「残HP少ない順」→「位置左側」

### その他（分類不能）
この項は上記優先度において分類不能な位置にいるスキルを記載していく。
ほとんどの場合は複合スキルとなっており、複合先のスキルの優先順位として発動するが、それまでで発動していない場合は最低優先度としてこの位置で発動する（実装時には発動しないスキルも存在したが、現状修正されてこの位置に入っている）。

「（分類不能）」と思われるスキル
- 全体リキャスト回復
    - 現在単独スキルとしては存在しない（はず）
    - 恐らく複合スキルの優先順位なのだが、優先順位のバフ先掛けで発動しない状況を作っても同優先順位で飛ぶためこの位置かどうかは怪しい
        - 速度バフ先掛け状態のゼットンs3が枷音s1よりも優先度が高いことを確認
- ランダム１体リキャスト回復
    - フィートs2で確認
        - 実装当初、発動しないバグを抱えていた
- 正月限定キャラのエンチャント
- 「このスキルで相手を倒した場合～」系スキルは恐らくここだが、必ずダメージと複合しているため実質的にダメージと同分類で良いと思われる
    - 発動効果は回復・バフ・リキャストなどがあるが全て攻撃タイミングに発動している